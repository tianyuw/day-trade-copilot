# 项目提案：0DTE Copilot (v1.1)

## 1. 项目概览
0DTE Copilot 是一个智能股票监控系统，旨在通过实时分析 1 分钟 K 线图来辅助交易者。它利用 **Gemini 3 Pro** 的多模态能力来解读市场数据、技术指标和可视化图表，从而提供预测性见解和可执行的交易信号。
*v1.1 版本重点优化了系统延迟、上下文效率和输出的结构化稳定性。*

## 2. 核心功能

### 2.1 持续 AI 分析与低延迟优化
- **模型**: Google Gemini 3 Pro (多模态)。
- **预判机制 (Pre-judgment)**: 为了抵消 LLM 推理延迟，系统不会等到 K 线完全收盘才调用。
  - 在每分钟的第 **50-55 秒**，系统会以当前最新价格作为“临时收盘价”提前发起调用。
  - 这确保了在下一分钟开始时，交易策略已经准备就绪。
- **上下文管理优化**:
  - **滚动摘要 (Rolling Summary)**: 系统不再传入原始的 30 分钟日志，而是维护一个动态更新的“市场叙事摘要”，概括当前趋势。
  - **关键帧 (Keyframes)**: 仅保留过去 30 分钟内发生过“状态突变”（如突破关键位、趋势反转）时刻的完整判断数据，剔除无效噪音。

### 2.2 多模态输入数据
在每个分析周期中，LLM 将接收：
1. **市场数据**: 过去 **30 分钟** 的 OHLCV (开盘价、最高价、最低价、收盘价、成交量) 序列数据。
2. **技术指标**: 过去 **30 分钟** 的技术指标序列 (EMA9, EMA21, Volume, VWAP, Bollinger Bands)。
3. **上下文记忆**: 动态更新的 **滚动摘要 (Rolling Summary)** 和筛选后的 **关键帧 (Keyframes)** 信息。
4. **视觉数据**: 生成的包含过去 30 分钟走势的 K 线图图片，图上叠加了上述技术指标以及计算出的支撑位/压力位。

### 2.3 结构化预测输出与风控
LLM 必须返回严格的 **JSON 格式** 数据，不再使用自由自然语言。
输出包含：
- **趋势预测**: 对未来 1-3 分钟的走势判断 (Bullish/Bearish/Neutral) 及置信度。
- **形态识别**: 识别当前 K 线技术形态 (e.g., Bull Flag, Doji)。
- **交易计划 (Action Plan)**:
  - **触发条件 (Trigger)**: 具体的价格突破点 (e.g., `price > 345.50`)。
  - **方向 (Side)**: Buy / Sell。
  - **止损位 (Stop Loss)**: 明确的止损价格，用于控制下行风险。
  - **止盈位 (Take Profit)**: 明确的止盈目标价格。
  
**示例 JSON Payload**:
```json
{
  "trend_prediction": "bullish",
  "confidence": 0.85,
  "action_plan": {
    "trigger_condition": "price > 345.50",
    "order_type": "buy",
    "stop_loss": 344.20,
    "take_profit": 348.00
  },
  "market_narrative_update": "Price is consolidating above EMA9, showing strength..."
}
```

### 2.4 实时执行监控
- **策略缓存 (Strategy Cache)**: 引入一个轻量级的内存缓存 (如 Redis 或 In-Memory Map)。
  - LLM 生成的最新 JSON 策略会即时写入该缓存。
  - 缓存中的策略具有“有效期”，过期（例如超过 2 分钟）自动失效，防止使用陈旧策略。
- 一个独立的、高频进程负责监控**秒级别**的 K 线数据。
- 该进程**持续轮询**策略缓存，获取最新的有效策略。
- 当秒级价格满足 `trigger_condition` 时，系统会立即触发警报，并同时展示建议的止损/止盈位。

### 2.5 回测引擎
- 支持“时光机”模式。
- 用户可以输入特定的股票代码 (Ticker) 和过去的时间戳。
- 系统从该时间点开始重放历史数据，模拟实时环境（包括预判机制的延迟模拟）以验证 AI 的表现。

## 3. 数据基础设施
- **提供商**: [Massive](https://massive.com/docs/websocket/stocks/overview)
- **技术**: WebSocket (流式传输)。
- **数据流**:
  - **分钟聚合**: 用于核心 AI 分析循环。
  - **秒级聚合**: 用于实时执行监控循环。

## 4. 系统架构
1. **数据摄取层**: 管理与 Massive 的 WebSocket 连接。
2. **处理层**:
   - 实时计算技术指标。
   - 渲染图表图片。
   - **上下文管理器**: 负责生成滚动摘要和维护关键帧列表。
3. **AI 编排器**: 在每分钟的特定时间窗口（如第 50 秒）触发预测请求，并将结果写入策略缓存。
4. **策略缓存 (Strategy Cache)**: 作为 AI 逻辑与实时监控之间的解耦层，存储最新的可执行计划。
5. **信号监控器**: 从缓存读取最新策略，对比实时秒级数据。
6. **用户界面**: 显示实时信号、止盈止损建议及历史回测控制。
